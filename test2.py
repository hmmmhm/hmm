import streamlit as st
import pandas as pd
import google.generativeai as genai
import os
from dotenv import load_dotenv

# í™˜ê²½ë³€ìˆ˜ì—ì„œ API í‚¤ ë¶ˆëŸ¬ì˜¤ê¸°
load_dotenv()
genai.configure(api_key=os.getenv("GOOGLE_API_KEY"))
model = genai.GenerativeModel("gemini-1.5-flash")  # ë˜ëŠ” gemini-1.5-pro / flash

# ì—‘ì…€ì—ì„œ ì„ ìƒë‹˜ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
@st.cache_data
def load_teacher_json():
    df = pd.read_excel("ã„³ã….xlsx")
    teacher_list = []
    for _, row in df.iterrows():
        name = str(row.get("ì„ ìƒë‹˜ ì„±í•¨", "")).strip()
        subject = str(row.get("í‚¤ì›Œë“œ", "")).strip()
        location = str(row.get("ìœ„ì¹˜", "")).strip()
        purpose = str(row.get("ëª©ì ", "")).strip()
        if name:
            teacher_list.append({
                "ì´ë¦„": name,
                "ê³¼ëª©": subject or "ì •ë³´ ì—†ìŒ",
                "ìœ„ì¹˜": location or "ì •ë³´ ì—†ìŒ",
                "ì„¤ëª…": purpose or "ì •ë³´ ì—†ìŒ"
            })
    return teacher_list

teacher_knowledge = load_teacher_json()

# ëŒ€í™” ì´ë ¥ì„ ìì—°ì–´ë¡œ ì •ë¦¬
def format_history(messages):
    formatted = ""
    for m in messages:
        if m["role"] == "user":
            formatted += f'ì‚¬ìš©ìê°€ ì´ë ‡ê²Œ ë§í–ˆì–´: "{m["content"]}"\n'
        else:
            formatted += f'AIê°€ ì´ë ‡ê²Œ ì‘ë‹µí–ˆì–´: "{m["content"]}"\n'
    return formatted.strip()

# í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
def build_prompt(messages, teacher_data):
    history = format_history(messages)
    prompt = f"""
ë„ˆëŠ” ê³ ë“±í•™êµ êµë¬´ì‹¤ ì•ˆë‚´ AIì•¼. ì™€ìš°ê³ ë“±í•™êµì˜ ì„ ìƒë‹˜ ì •ë³´ì™€ ëŒ€í™” ë‚´ì—­ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì¹œì ˆí•˜ê³  ì •í™•í•œ ì•ˆë‚´ë¥¼ ì œê³µí•´ì¤˜.

ğŸ“Œ ì•„ë˜ëŠ” ì„ ìƒë‹˜ ì •ë³´ì•¼:
{teacher_data}

ğŸ“Œ ì•„ë˜ëŠ” ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™”ì•¼:
{history}

ğŸ“Œ ë‹¤ìŒ ì‚¬ìš©ì ì…ë ¥ì— ëŒ€í•´ ë‹µë³€í•  ë•Œ ë°˜ë“œì‹œ ì•„ë˜ ê·œì¹™ì„ ì§€ì¼œ:

---

ğŸ¯ [ê°€ì¥ ì¤‘ìš”í•œ ê·œì¹™ â€“ ìµœìš°ì„  ì¡°ê±´]:

- ì‚¬ìš©ìê°€ ìì‹ ì„ "ì™¸ë¶€ì¸"ì´ë¼ê³  í‘œí˜„í•œ ê²½ìš° (ì˜ˆ: ì™¸ë¶€ì¸, ë°©ë¬¸ì, ì¡¸ì—…ìƒ ë“±) ì•„ë˜ ë¬¸ì¥ í•˜ë‚˜ë§Œ ì¶œë ¥í•˜ê³ , ê·¸ ì´í›„ì— ì•ˆë‚´ë¥¼ ì ˆëŒ€ í•˜ì§€ ë§ˆ.
  â†’ "ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ì•ˆë‚´ ì„œë¹„ìŠ¤ëŠ” ì™€ìš°ê³ ë“±í•™êµ ë‚´ë¶€ êµ¬ì„±ì›(í•™ìƒ, êµì§ì›)ì„ ìœ„í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ì–‘í•´ ë¶€íƒë“œë¦½ë‹ˆë‹¤."

- ì´ ê²½ìš°, ë‹¤ì‹œ ì¸ì‚¬ë§ì„ ë°˜ë³µí•˜ê±°ë‚˜ ì§ˆë¬¸ì„ ìœ ë„í•˜ì§€ ë§ˆ. (ì¦‰ì‹œ ì¢…ë£Œ ì‘ë‹µ)

---

ğŸ“ ì¼ë°˜ ì‘ë‹µ ê·œì¹™:

- ì‚¬ìš©ìì˜ ë§ˆì§€ë§‰ ë°œí™”ê°€ **ì„ ìƒë‹˜ ê´€ë ¨ ì§ˆë¬¸ì´ ì•„ë‹ˆë©´**, ì„ ìƒë‹˜ ì •ë³´ë¥¼ ì œê³µí•˜ì§€ ë§ˆ.
- ê°„ë‹¨í•œ ì¸ì‚¬ë§ì´ë‚˜ ì¼ìƒ ëŒ€í™”ëŠ” ì§§ê³  ì •ì¤‘í•˜ê²Œ ì‘ë‹µí•´.

- ì„ ìƒë‹˜ ì•ˆë‚´ ì‹œì—ëŠ” ë‹¤ìŒ ê·œì¹™ì— ë”°ë¼ ì‘ë‹µí•´:
  - ì§ì ‘ì ìœ¼ë¡œ ì–¸ê¸‰ëœ ê³¼ëª©ë¿ë§Œ ì•„ë‹ˆë¼, ê´€ë ¨ ìœ ì‚¬ ê³¼ëª©ë„ í•¨ê»˜ ê³ ë ¤í•´.
  - ì˜ˆë¥¼ ë“¤ì–´ ì‚¬ìš©ìê°€ "êµ­ì–´ ì„ ìƒë‹˜ ì•Œë ¤ì¤˜"ë¼ê³  í•˜ë©´, êµ­ì–´ ì™¸ì—ë„ ë¬¸í•™, ì–¸ì–´ì™€ ë§¤ì²´, í™”ë²•ê³¼ ì‘ë¬¸ ë‹´ë‹¹ ì„ ìƒë‹˜ë„ í•¨ê»˜ ì•ˆë‚´í•´.
  - ì„ ìƒë‹˜ì„ ì•ˆë‚´í• ë•Œ ëª©ë¡ í˜•íƒœë¡œ ë‚˜ì—´í•´ì„œ ì•ˆë‚´í•´. ì•„ë˜ëŠ” ì˜ˆì‹œì•¼:
      â€¢ ê¹€ìˆ˜í˜„ ì„ ìƒë‹˜: ì„¤ëª…

- ë¹„ì†ì–´ê°€ í¬í•¨ë˜ë©´ ì •ì¤‘íˆ ê²½ê³ í•˜ê³ , ë°˜ë³µ ì‹œ ì•ˆë‚´ë¥¼ ì¤‘ë‹¨í•´.

---

ğŸ” ëŒ€í™” íë¦„ ê´€ë ¨ ê·œì¹™:

- ì‚¬ìš©ìê°€ "ë"ì´ë¼ê³  ì •í™•íˆ ë§í•˜ë©´, ì§€ê¸ˆê¹Œì§€ì˜ ëŒ€í™”ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•´.
- ì´ì „ì— í–ˆë˜ ì‚¬ìš©ìë‚˜ ë„ˆì˜ ë§ì€ ë‹¤ì‹œ ë§í•˜ì§€ ë§ˆ.
- ì¸ì‚¿ë§ì€ ì²˜ìŒì—ë§Œ í–ˆë‹¤ë©´ ë‹¤ì‹œ í•  í•„ìš” ì—†ì–´:
  â†’ "ì•ˆë…•í•˜ì„¸ìš”! ì™€ìš°ê³ ë“±í•™êµ ì„ ìƒë‹˜ ì•ˆë‚´ ë„ìš°ë¯¸ì…ë‹ˆë‹¤. ê¶ê¸ˆí•œ ì„ ìƒë‹˜ ì •ë³´ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”. ë¨¼ì € ë‹¹ì‹ ì€ í•™ìƒì¸ê°€ìš”, êµì§ì›ì¸ê°€ìš”, ì™¸ë¶€ì¸ì¸ê°€ìš”?"

---

ğŸš« ì ˆëŒ€ í•˜ì§€ ë§ì•„ì•¼ í•  í–‰ë™:

- ì‚¬ìš©ìì˜ ë°œí™”ë¥¼ ë‹¤ì‹œ ìš”ì•½í•˜ê±°ë‚˜ ë˜í’€ì´í•˜ì§€ ë§ˆ.  
  (ì˜ˆ: "ë¬¼ë¦¬ ì„ ìƒë‹˜ì„ ì°¾ìœ¼ì‹œëŠ”êµ°ìš”", "ì²´ìœ¡ ìˆ˜í–‰í‰ê°€ ê´€ë ¨ ì§ˆë¬¸ì´ì‹œêµ°ìš”" ê°™ì€ ë¬¸ì¥ì€ ì“°ì§€ ë§ˆ.)

- ì‚¬ìš©ìì˜ ë§ì„ ë‹¤ì‹œ `ì‚¬ìš©ì:` í˜•íƒœë¡œ ë°˜ë³µí•˜ê±°ë‚˜ ì¬êµ¬ì„±í•´ì„œ ë§í•˜ì§€ ë§ˆ.

- AIëŠ” ì˜¤ì§ **ìì‹ ì˜ ì—­í• ë¡œë§Œ** ì¹œì ˆí•˜ê³  ìì—°ìŠ¤ëŸ½ê²Œ ì•ˆë‚´í•´. ì‚¬ìš©ìì˜ ë§ì€ AI ì‘ë‹µì—ì„œ ì‚¬ë¼ì ¸ì•¼ í•´.

---

ì´ì œ ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ì‚¬ìš©ì ì…ë ¥ì— ëŒ€í•´ ìì—°ìŠ¤ëŸ½ê³  ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ì¤˜.
"""
    return prompt

# Gemini ì‘ë‹µ ìƒì„± í•¨ìˆ˜
def get_gemini_response(prompt):
    try:
        response = model.generate_content(prompt)
        return response.text
    except Exception as e:
        return f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

# Streamlit ì¸í„°í˜ì´ìŠ¤
st.title("ì„ ìƒë‹˜ ì•ˆë‚´")

if "messages" not in st.session_state:
    st.session_state.messages = []
    st.session_state.messages.append({
        "role": "assistant",
        "content": "ì•ˆë…•í•˜ì„¸ìš”! ì™€ìš°ê³ ë“±í•™êµ ì„ ìƒë‹˜ ì•ˆë‚´ ë„ìš°ë¯¸ì…ë‹ˆë‹¤.\nê¶ê¸ˆí•œ ì„ ìƒë‹˜ ì •ë³´ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”.\n\në¨¼ì €, ë‹¹ì‹ ì€ í•™ìƒì¸ê°€ìš”? êµì§ì›ì¸ê°€ìš”? ì™¸ë¶€ì¸ì¸ê°€ìš”?"
    })

# ê¸°ì¡´ ëŒ€í™” ì¶œë ¥
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

# ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
if user_input := st.chat_input("ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš” (ì˜ˆ: ê³¼í•™ ì„ ìƒë‹˜ ì–´ë”” ê³„ì„¸ìš”?)"):
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.markdown(user_input)

    # í”„ë¡¬í”„íŠ¸ êµ¬ì„± ë° Gemini ì‘ë‹µ
    teacher_json = str(teacher_knowledge)
    prompt = build_prompt(st.session_state.messages, teacher_json)
    response = get_gemini_response(prompt)

    st.session_state.messages.append({"role": "assistant", "content": response})
    with st.chat_message("assistant"):
        st.markdown(response)
